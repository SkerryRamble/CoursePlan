<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />	<!-- Boilerplate: set the character encoding -->
		<meta name="viewport" content="width=device-width, initial-scale=1">	<!-- Boilerplate: declare the viewport default settings -->
		<title>Course Plan</title>		<!-- Title of the page which appears in the browser tab -->
		<link rel="shortcut icon" href="/images/capman_icon.ico">	<!--link to the icon that appears in the browser tab-->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa|Exo|Orbitron|Raleway">
		<script src="jquery-3.7.1.min.js"></script>
		
	</head>
	<body></body>
</html>

<script>
	
	var Engine = {
		
		CoursePlan: {
			YearData: null
		},
		
		Init: function() { //an inner function "init"
			Engine.Canvas = document.createElement('canvas'); //create a canvas element
			Engine.Canvas.id = "display"; //give it an id to reference later
			Engine.Canvas.width = 800; //the width
			Engine.Canvas.height = 600; //the height
			$('body').append(Engine.Canvas); //finally append the canvas to the page			
			
			
			
			Engine.GetData();
			
			
			Engine.Canvas.Context = Engine.Canvas.getContext('2d'); //set the canvas to render in 2d.
			Engine.GameLoop(); //start rendering the game!				
		},
		GameRunning: null, //this is a new variable so we can pause/stop the game
		Update: function() { //this is where our logic gets updated			
			Engine.Draw(); //call the canvas draw function
		},
		
		GetData: function() {
			var xhr = new XMLHttpRequest();
			xhr.addEventListener("load",Engine.DataGot);	//we'll need to wait for the response and when we get it call the DataGot function
			xhr.open("GET", 'https://skerryramble.github.io/CoursePlan/yearcourses.json',true);			
			xhr.send();		
		},
		
		DataGot: function(){
		console.log("f");
			//due to possible network delays we need to add a listener event to the XHR so we don't try to process it until it has finished transferring
			//TODO: There's a new way to to this. Act on 200
			Engine.YearData = JSON.parse(this.responseText);
			//console.log(Engine.YearData);
			
			//what we want is a loop of all the xy coords of courses from the course schedule, stored in YearData
			var data = Engine.YearData;
			var calendar_height = 96;	
			var one_day = 1000 * 60 * 60 * 24;
			var number_of_streams = 3;
			var calendar_gap = 6;
			var screen_width = 91;
			var number_of_quarters = 4;
			var stream_height = (calendar_height - (4 * calendar_gap))/ number_of_quarters / number_of_streams;	
			console.log(data);
			console.log(Engine.YearData);
			for(slot in data){		
			
			//This is being called way too many times...???TODO
				//console.log(data[slot]);
				
				//if (data[slot].id != null){
					console.log(data[slot].id);
					var date_start = new Date(data[slot].date_start);
					var date_end = new Date(data[slot].date_end);	//need to take date_end+1
					var day_diff = new Date(date_end - date_start);
					var slot_width = Math.floor(day_diff/one_day) + 1;
					var level = data[slot].stream-1;	//not so simple, stream = lecture_room_id which is not linear; we need to assign these accurately
					if (level > 6) {level = 4;}	//account for odd indexing from sql of lecture_room_id table					
					
					var jan1 = new Date('1 January 2017');
					day_diff = new Date(date_start - jan1);
					var slot_x = Math.floor(day_diff/one_day);
					var slot_y = ((number_of_streams-1) * stream_height);				
					
					//Calculate overshoot of right edge of calendar
					if (slot_x + slot_width > (3 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (2 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (1 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					Engine.Rect(slot_x,slot_y,slot_width,stream_height,"red");
				//}
				
				return false;
			}
			
		},
		
		Draw: function() { //this is where we will draw all the information for the game!
			Engine.Canvas.Context.clearRect(0,0,Engine.Canvas.width,Engine.Canvas.height); //clear the frame
			
			
			
			
			
			Engine.GameLoop(); //re-iterate back to gameloop
		},
		GameLoop: function() { //the gameloop function
			Engine.GameRunning = setTimeout(function() { 
				requestAnimFrame(Engine.Update, Engine.Canvas); 
			}, 1);
		},
		
		Rect: function(x,y,w,h,col) { //x position, y position, width, height and colour
			if (col.length > 0) { //if you have included a colour
				Engine.Canvas.Context.fillStyle = col; //add the colour!
			}
			Engine.Canvas.Context.fillRect(x,y,w,h); //draw the rectangle
		},
		Text: function(text, x, y, font, size, col) { //the text, x position, y position, font (arial, verdana etc), font size and colour
			if (col.length > 0) { //if you have included a colour
				Engine.Canvas.Context.fillStyle = col; //add the colour!
			}
			Engine.Canvas.Context.font = size + "px " + font;
			Engine.Canvas.Context.fillText(text,x,y);
		}
		
		
		
		
		
		
		
		
		
	}
	
	window.requestAnimFrame = (function(){	//this is some animation handling code
		return window.requestAnimationFrame || 
		window.webkitRequestAnimationFrame || 
		window.mozRequestAnimationFrame || 
		window.oRequestAnimationFrame || 
		window.msRequestAnimationFrame || 
		function (callback, element){
			fpsLoop = window.setTimeout(callback, 1000 / 60);
		};
	}());
	
	window.onload = Engine.Init(); //the engine starts when window loads
	
	
	
	
	
	
	
	
	var display_year;
	var all_course_divs;
	
	$(document).ready(function() {
		var temp = new Date();
		//display_year = temp.getFullYear();
		//draw_main();
	});
	
	
	function draw_main(){
		document.getElementById("displayed_year").innerHTML = display_year;
		get_year();
	}
	
	function year_up(){
		display_year++;
		draw_main();
	}
	
	function year_down(){
		display_year--;
		draw_main();
	}
	
	function get_year(){
		document.getElementById('year').innerHTML = '';
		
		$.ajax ({
			type: "GET",
			url: 'https://skerryramble.github.io/CoursePlan/courses.json' + display_year,			
			datatype:'json',
			success: function(data){
				draw_year(data);
				
			},
			error: function(data){alert('oops! course data could not be retrieved');}
		});
		
	}
	
	function draw_year(data){	
		//get how many and which streams are visible, jumping out if none are
		var stream_1 = document.getElementById('stream1').checked;
		var stream_2 = document.getElementById('stream2').checked;
		var stream_3 = document.getElementById('stream3').checked;
		var stream_4 = document.getElementById('stream4').checked;
		var stream_5 = document.getElementById('stream5').checked;		
		var number_of_streams = stream_1 + stream_2 + stream_3 + stream_4 + stream_5;
		
		if (number_of_streams < 1){return;}
		
		var calendar_height = 96;	
		draw_calendar(number_of_streams, calendar_height);
		
		
		var all = '';
		var current_slot = '';
		var day_width = 1;		
		var one_day = 1000 * 60 * 60 * 24;
		var screen_width = 91;
		var calendar_gap = 6;
		
		var number_of_quarters = 4;
		var stream_height = (calendar_height - (4 * calendar_gap))/ number_of_quarters / number_of_streams;	
		
		var has_quiz = document.getElementById('has_quiz').checked;
		console.log(has_quiz);
		
		for(slot in data){
			//check is this slot in a visible stream
			if (
			(data[slot].stream == 1 && stream_1) ||
			(data[slot].stream == 2 && stream_2) ||
			(data[slot].stream == 3 && stream_3) ||
			(data[slot].stream == 4 && stream_4) ||
			(data[slot].stream == 9 && stream_5)
			){		
				
				if (data[slot].id != null){
					var date_start = new Date(data[slot].date_start);
					var date_end = new Date(data[slot].date_end);	//need to take date_end+1
					var day_diff = new Date(date_end - date_start);
					var slot_width = Math.floor(day_diff/one_day) + 1;
					var level = data[slot].stream-1;	//not so simple, stream = lecture_room_id which is not linear; we need to assign these accurately
					if (level > 6) {level = 4;}	//account for odd indexing from sql of lecture_room_id table					
					
					var jan1 = new Date('1 January ' + display_year);
					day_diff = new Date(date_start - jan1);
					var slot_x = Math.floor(day_diff/one_day);
					var slot_y = ((number_of_streams-1) * stream_height);				
					
					//Calculate overshoot of right edge of calendar
					if (slot_x + slot_width > (3 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (2 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (1 * screen_width)){
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					
					
					var rotate = '';
					if (slot_width<4) {rotate = " rotate_text"; };
					var font_size = 0.15 * slot_width;
					
					var highlight_quiz = '';
					if (data[slot].setup_quiz == true && has_quiz == true) { highlight_quiz = " course_quiz_highlight"; };
					console.log(level, stream_height, slot_y);
					var current_slot = '<div class="course_slot' + highlight_quiz + '" style="' +
					'font-size:' + font_size + 'em;' +
					'width:calc(' + (slot_width * day_width) + 'vw);' +
					'height:calc(' + stream_height + 'vh);' +
					'left:calc(8vw + '+ slot_x + 'vw);' +
					'top:calc(5vh + ' + slot_y + 'vh);' +
					'background-color:' + data[slot].background_main + ';' +
					'color:' + data[slot].foreground + ';' +
					'" data-myattribute="' + data[slot].id +
					'"><div class="course_slot_inner' + rotate + '">' + data[slot].code + ' - ' + data[slot].po + '</div></div>';
					
					all += current_slot;
				}
			}
		}
		
		//TODO: the response delay prevents instant drawing, either find a method to account for delay then draw, or revert back to the older flickery method
		
		document.getElementById('year').innerHTML += all;
		
		var entire_class = document.getElementsByClassName('course_slot');
		for (var i=0;i<entire_class.length;i++){
			entire_class[i].addEventListener('click', myFunction, false);			
		}		
	}
	
	function get_stream_test() {
		var a,b,c;
		
		var xhttp;
		
		xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				a = this.responseText;
				console.log(a,1);
			}
		};
		xhttp.open("GET", 'api/stream_c/' + display_year, true);
		xhttp.send();
		
		console.log(a,2);
		draw_stream(a,0);
	}
	
	
	function draw_calendar(number_of_streams, calendar_height){
		//populate the month/week/date lines with their content
		//need to calculate the '1st' week of the year, week_position_1 can never have wed=5th jan which constrains our choice
		
		var x_pos_increment = 24;
		var calendar = document.getElementById('calendar');
		var inner_calendar = '';
		var x_pos = 0;
		for (var i=1;i<5;i++){
			inner_calendar +='<div class="month_line" style="top:' + x_pos + 'vh;">months</div>';
			inner_calendar +='<div class="week_line" style="top:' + (2 + x_pos) + 'vh;">weeks</div>';
			inner_calendar +='<div class="date_line" style="top:' + (4 + x_pos) + 'vh;">dates</div>';
			x_pos += x_pos_increment;
		}
		var calendar = document.getElementById('calendar');
		calendar.innerHTML = inner_calendar;
		
		var wks_q1, wks_q2, wks_q3, wks_q4;
		for (var i=1;i<=13;i++){
			
		}		
	}
	
	
	var myFunction = function() {
		var attribute = this.getAttribute("data-myattribute");
		//alert("You chose course with id=" + attribute);
		
		
		//window.open("file://///Z:/","","width=960,height=960");
		//window.open();
		
		
		
		var obj_url = window.URL.createObjectURL("file://S:/test.pdf");
		var iframe = document.getElementById('viewer');
		iframe.setAttribute('src', obj_url);
		window.URL.revokeObjectURL(obj_url);
	};
	
	//todo, can't open a file from code, best we can do is provide a URL to copy-paste for the user to the file_reader and do that. maybe there's a way to 'magic' the url into the filereader
	function readSingleFile(e) {
		var file = e.target.files[0];
		if (!file) {
			return;
		}
		var reader = new FileReader();
		reader.onload = function(e) {
			var contents = e.target.result;
			displayContents(contents);
		};
		reader.readAsText(file);
	}
	
	function displayContents(contents) {
		var element = document.getElementById('file-content');
		element.innerHTML = contents;
	}
	
	
	
</script>
