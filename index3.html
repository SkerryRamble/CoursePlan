<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" /> <!-- Boilerplate: set the character encoding -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Boilerplate: declare the viewport default settings -->
	<title>Course Plan</title> <!-- Title of the page which appears in the browser tab -->
	<!-- <link rel="shortcut icon" href="/images/capman_icon.ico"> link to the icon that appears in the browser tab -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa|Exo|Orbitron|Raleway">
	<link rel="icon" href="data:,">

	<style>
		body,
		html {
			box-sizing: border-box;
			margin: 0px;
			padding: 0px;
			font: 1rem Comfortaa, Helvetica, sans-serif;
			clear: both;
		}

		.year_text_class {
			position: absolute;
			bottom: 1.2vh;
			right: 0.2vw;
			font-size: 3vw;
			z-index: 5;
		}

		.created_text_class {
			position: absolute;
			bottom: 0.2vh;
			right: 0.2vw;
			font-size: 0.8vh;
			z-index: 5;
		}


		.hotel_icon {
			position: absolute;
			bottom: 0.1vh;
			right: 0.1vw;
			height: 1.5vh;
			width: 1.5vw;
		}

		.special_comment_icon {
			position: absolute;
			bottom: 0.1vh;
			left: 0.1vh;
			height: 1.5vh;
			z-index: 20;
		}

		.year_view {
			overflow: hidden;
			width: 91vw;
			height: 96vh;
			background: whitesmoke;
			position: fixed;
			left: 8.5vw;
			top: 2vh;
			border: 0.1vw solid black;
			margin: 0;
			padding: 0;
			font-weight: normal;
		}

		.week_style {
			width: 7vw;

			font-family: sans-serif;
			position: absolute;
			border-left: 0.01vw solid black;
			text-align: center;
			user-select: none;
			font-weight: normal;
		}

		.date_style {
			width: 1vw;

			font-size: 0.5vw;
			font-family: sans-serif;
			position: absolute;
			border-left: 0.01vw solid black;
			text-align: center;
			user-select: none;
			font-weight: normal;
			/* cursor: url(http://capman.jvi.org/images/cal.png), default; */
		}

		.month_border {
			width: 1vw;
			height: 2vh;
			line-height: 2vh;
			font-size: 0.5vw;
			font-family: sans-serif;
			position: absolute;
			border-left: 0.01vw solid black;
			text-align: center;
			user-select: none;
			font-weight: normal;
		}

		.month_style {
			/* width:1vw; */

			/* font-size: 0.5vw; */
			font-family: sans-serif;
			position: absolute;
			/* border-left:0.01vw solid black; */
			text-align: center;
			user-select: none;
			font-weight: normal;
		}

		.overlap_trailing_edge:after {
			content: " ";
			display: block;
			position: absolute;
			top: 0px;
			right: -1vw;
			width: 2vw;
			height: 100%;
			background: linear-gradient(-135deg, rgba(255, 255, 255, 0.5) 50%, transparent 50%) 0 0%, transparent linear-gradient(-45deg, rgba(255, 255, 255, 0.5) 50%, transparent 50%) 0 0%;
			background-repeat: repeat-y;
			background-size: 1vw 1vh;
			z-index: 3;
		}

		.overlap_leading_edge:after {
			content: " ";
			display: block;
			position: absolute;
			top: 0px;
			left: 0px;
			width: 1vw;
			height: 100%;
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 50%, transparent 50%) 0 0%, transparent linear-gradient(45deg, rgba(255, 255, 255, 0.5) 50%, transparent 50%) 0 0%;
			background-repeat: repeat-y;
			background-size: 1vw 1vh;
			z-index: 3;
		}

		.weekend_class {
			background: rgba(0, 0, 0, 0.1);
			height: 96vh;
			border: none;
		}

		.holiday_class {
			background: rgb(0, 255, 0);
			color: black;
		}

		/* .course_slot {
			box-sizing: border-box;
			position: absolute;
			border: 0.01vw solid black;
			border-bottom: none;
			/*covered by stream borders */
		border-top: none;
		/*covered by stream borders */
		padding: 0px;
		margin: 0px;
		cursor: -webkit-zoom-in;
		line-height: 3vh;
		}

		*/ .course_slot:hover {
			animation: zooming .2s;
			animation-fill-mode: forwards;
			z-index: 99;
		}

		.rotate_slot_detected {
			box-sizing: border-box;
			position: absolute;
			border: 0.01vw solid black;
			border-bottom: none;
			/*covered by stream borders */
			border-top: none;
			/*covered by stream borders */
			padding: 0px;
			margin: 0px;
			cursor: -webkit-zoom-in;
		}

		.rotate_slot_detected:hover {
			animation: zooming_from_rotated .2s;
			animation-fill-mode: forwards;
			z-index: 99;
		}

		@keyframes zooming {

			/*from {
		transform: scale(1);
		-ms-transform: scale(1);
	}
	to {
		transform: scale(1.01);
		-ms-transform: scale(1.01);
		transform-origin: center;
		-ms-transform-origin: center;
		border: 3px solid black;
		z-index:99;
	}*/
			from {}

			to {
				box-shadow: inset 0px 0px 0.2vw 0.1vw black
			}
		}

		@keyframes zooming_from_rotated {
			from {
				transform: scale(1);
				-ms-transform: scale(1);
			}

			to {
				transform: scale(1.05) rotateZ(0deg);
				-ms-transform: scale(1.05) rotateZ(0deg);
				transform-origin: right;
				-ms-transform-origin: right;
				border: 1px solid black;
				z-index: 99;
				width: 5vw;
				font-size: 1vh;
				line-height: 1vh;
			}
		}

		.rotate_text {
			transform: rotateZ(90deg);
		}

		.course_slot_inner {
			text-align: center;
			width: 100%;
			overflow: hidden;
			display: block;
			/*reset from inline*/
			margin: 0;
			/*remove defaults*/
			padding: 0px;
			white-space: pre;
			z-index: 1;
			font-weight: bold;
		}

		.active_highlight_residence:before {
			content: " ";
			display: block;
			position: absolute;
			top: 0px;
			right: 0px;
			/* width:100%; */
			/* height:100%; */
			/* background: linear-gradient(-135deg, rgba(255,0,0,0.5) 0, rgba(255,0,0,0.5) 2vw, transparent 2vw, transparent); */
			width: 2vw;
			height: 2vw;
			background: url('../images/residence_icon.svg') no-repeat;
			background-size: contain;

		}

		.active_highlight_today {
			animation: glowing 5s infinite;
			background: rgba(0, 255, 0, 0.35);
			z-index: 4;
		}


		.active_highlight_shared_costs {
			outline: 0.5vw solid rgba(255, 0, 255, 0.8);
			z-index: 4;
		}


		.active_highlight_po {
			outline: 0.5vw solid rgba(255, 0, 0, 0.8);
			z-index: 4;
		}


		.active_highlight_org {
			outline: 0.5vw solid rgba(0, 0, 255, 0.8);
			z-index: 4;
		}

		.active_highlight_interpretation {
			/*outline: 4px solid yellow;*/
			border: 5px solid transparent;
			border-image: linear-gradient(to bottom, white 30%, blue 30%, blue 70%, red 70%, red);
			border-image-slice: 1;
			z-index: 4;
		}

		@keyframes glowing {
			0% {
				box-shadow: 0 0 4px 4px rgb(0, 255, 0);
			}

			25% {
				box-shadow: 0 0 6px 5px rgb(0, 255, 255);
			}

			50% {
				box-shadow: 0 0 8px 6px rgb(255, 0, 255);
			}

			75% {
				box-shadow: 0 0 6px 5px rgb(255, 255, 0);
			}

			100% {
				box-shadow: 0 0 4px 4px rgb(0, 255, 0);
			}
		}

		.course_quiz_highlight {
			border: 4px solid indianred;
			z-index: 10;
			animation: glowing 1500ms infinite;
		}

		.month_line {
			background: lightgray;
		}

		.month_line,
		.date_line,
		.week_line {
			left: 0;
			line-height: calc(2vh - 1px);
			height: calc(2vh - 1px);
			width: 100%;
			position: absolute;
			border-top: 1px solid rgba(0, 0, 0, 0.8);
		}

		.streams {
			border-top: 1px solid black;
			width: 91vw;
			position: absolute;
		}

		.schedule_ul {
			list-style: none;
			margin: 0;
			padding: 0;
		}

		.schedule_li {
			display: block;
			text-align: center;
			z-index: -1;
		}

		.schedule_td,
		.schedule_th,
		.schedule_tr {
			padding: 0px;
			line-height: 1.5vh;
			height: 1.5vh;
		}

		.schedule_table {
			border-spacing: 0px;
			border-collapse: collapse;
		}

		.schedule_input[type=checkbox],
		.schedule_input[type=radio] {
			position: absolute !important;
			clip: rect(0, 0, 0, 0);
			overflow: hidden;
		}

		.schedule_label {
			user-select: none;
			font: bold 1.15vh Exo, sans-serif;
			line-height: 1.5vh;
			height: 1.5vh;
			border: 0.05vw solid rgba(0, 0, 0, 0.6);
			box-shadow: none;
			width: 4vw;
			text-align: center;
			display: inline-block;
			background: orange;
			/*position:fixed;*/
			left: 4.5vw;
			white-space: pre;
		}

		.schedule_input:checked+.schedule_label {
			background-color: rgba(16, 250, 32, 1);
			box-shadow: 0.2vw 0.2vw 0.1vw grey;
		}

		.schedule_button {
			margin: 0px;
			padding: 0px;
			/*position:fixed;*/
			user-select: none;
			font: 0.75vw Exo, sans-serif;
			border: 0.05vw solid rgba(0, 0, 0, 0.6);
			box-shadow: none;
			height: 2vh;
			line-height: 2vh;
			width: 2vw;
			text-align: center;
			display: inline-block;
			background: steelblue;
			vertical-align: middle;
			outline: none;
			color: white;
		}

		.schedule_button:hover {
			background: lightsteelblue;
		}

		.schedule_button:active {
			background: yellow;
		}

		.tally_box {
			right: -1vw;
			bottom: 0;
			position: absolute;
			background: white;
			outline: 1px solid black;
			width: 1vw;
			text-align: center;
			color: black;
			z-index: 9;
			font-size: 1vh;
			height: 1vh;
			line-height: 1vh;
		}

		.special_comment {
			left: 0;
			bottom: 0;
			position: absolute;
			background: white;
			border: 2px solid rgba(255, 0, 0, 0.5);
			border-radius: 0.5vw;
			width: 0.5vw;
			height: 0.5vw;
			z-index: 4;
		}

		@media print {
			.year_view {
				background-color: white;
				left: 4.5vw;
				overflow: hidden;
				width: 91vw;
			}

			.hide_with_print {
				display: none;
			}

			@page {
				margin: 0.0cm;
				padding: 0.0cm;
			}
		}

		.year_view {
			width: 91vw;
			height: 96vh;
			background: whitesmoke;
			position: fixed;
			left: 8vw;
			top: 3vh;
			border: 1px solid black;
			margin: 0;
			padding: 0;
		}

		.course_slot {
			box-sizing: border-box;
			position: absolute;
			border-radius: 4px;
			font: bold 2rem Comfortaa, Helvetica, sans-serif;
			border: 1px solid #808080;
			padding: 0px;
			margin: 0px;
			cursor: -webkit-zoom-in;
			z-index: 2;
			overflow: hidden;
			line-height: 3vh;
		}

		.course_slot_inner {
			text-align: center;
			width: 100%;
			overflow: hidden;
			display: block;
			/*reset from inline*/
			margin: 0;
			/*remove defaults*/
			padding: 0px;
		}

		.rotate_text {
			transform: rotate(90deg) translateX(3vh);
			transform-origin: 50% 50%;
		}


		@keyframes glowing {
			0% {
				box-shadow: 0 0 2px rgba(205, 92, 92, 0.5);
			}

			50% {
				box-shadow: 0 0 3px rgba(205, 92, 92, 1);
			}

			100% {
				box-shadow: 0 0 2px rgba(205, 92, 92, 0.5);
			}
		}

		.month_line,
		.date_line,
		.week_line {
			left: 0;
			height: 2vh;
			width: 100%;
			position: absolute;
			z-index: 0;
			font-size: 1vh;
		}

		.month_line {
			background: grey;
		}

		.date_line {
			background: lime;
		}

		.week_line {
			background: yellow;
		}

		.week_box {
			width: 7vw;
			border: 1px solid black;
		}

		input.switch:empty {
			margin-left: -999px;
		}

		input.switch:empty~label {
			position: relative;
			float: left;
			line-height: 1.6em;
			text-indent: 4em;
			margin: 0.2em 0;
			cursor: pointer;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		input.switch:empty~label:before,
		input.switch:empty~label:after {
			position: absolute;
			display: block;
			top: 0;
			bottom: 0;
			left: 0;
			content: ' ';
			width: 3.6em;
			background-color: #c33;
			border-radius: 0.3em;
			box-shadow: inset 0 0.2em 0 rgba(0, 0, 0, 0.3);
			-webkit-transition: all 100ms ease-in;
			transition: all 100ms ease-in;
		}

		input.switch:empty~label:after {
			width: 1.4em;
			top: 0.1em;
			bottom: 0.1em;
			margin-left: 0.1em;
			background-color: #fff;
			border-radius: 0.15em;
			box-shadow: inset 0 -0.2em 0 rgba(0, 0, 0, 0.2);
		}

		input.switch:checked~label:before {
			background-color: #393;
		}

		input.switch:checked~label:after {
			margin-left: 2em;
		}
	</style>



</head>

<body>

	<!-- Trying to go with HTML5 where possible, and avoid jQuery. No technical reason, other than to see if I can
		After I finish this, I might try redo it again with HTMX
		JMC 150824

		General Notes
		150824: Fixed a bunch of things, but also saw a lot more that needs fixing, as is always the way.
		Biggest fix was realising a lot of styling elements were being referenced but not defined > missing css page!
		So I copy pasted my old work one. TODO, need to clean it out from stuff that's irrelevant, probably 80%+
		190824: Reworked a lot of the draw slots code, cleaned it up and redesigned the positioning logic
-->

	<div>
		<div>
			<button onclick="year_down();">-</button>
			<button onclick="year_up();">+</button>
			<div id="displayed_year"></div>
			<div onclick="draw_main();">
				<input type="checkbox" id="stream1" name="switch1" class="switch" checked="true" />
				<label for="stream1">600A</label>
			</div>
			<div>&nbsp;</div>
			<div onclick="draw_main();">
				<input type="checkbox" id="stream2" name="switch2" class="switch" checked="true" />
				<label for="stream2">600B</label>
			</div>
			<div>&nbsp;</div>
			<div onclick="draw_main();">
				<input type="checkbox" id="stream3" name="switch3" class="switch" checked="true" />
				<label for="stream3">600C</label>
			</div>
			<div>&nbsp;</div>
		</div>
	</div>
	<div class="year_view container">
		<div id="calendar"></div>
		<div id="year"></div>
	</div>
</body>

</html>

<script>


	/* TODO: things to be done, not bugs
		BUG: identified problem needs to be fixed
		WISH: isn't broken but too badly written and should be fixed given time
		NOTE: Just something I found interesting or necessary to highlight
	
		TODO: search for TODOs within script
		
		BUGs: draw level for course streams is bonkers
		i added courses for 2023 as well, but they are drawn in the wrong date slots. Picasso computer quote springs to mind
		Whoops! I added them to the same file. I need to break them in to 2 files, one per year and bring back the api calls ability to handle that
		Also, the first_day thing needs to be called by draw_slots. I forgot to add it there too.
		Ah, the pitfalls of copy-paste

		NOTE: After fixing the draw_slot function, it works decently now. There's always ways to improve things, and this is a far cry from the full functionality of the original.
		But I don't want to spend ages recreating some mock data for that old app, so there's no point in recreating the old functionality for that (yet)
		I'm happy with this for now, some things I might fix later are:
		* visual flourishes here and there
		* font choices
		* button placing etc >> mostly aesthetic stuff
		* Have a go at getting some AI bot to make mock data for me en masse. That'd be handy

	*/

	//Given the scope of this app, it's ok to make display_year global
	let display_year;

	window.onload = function () {
		init();
	};

	function init() {
		//set the Overview to the current year on start up
		const temp = new Date();
		display_year = 2022; //temp.getFullYear();
		draw_main();
	}

	function draw_main() {
		document.getElementById("displayed_year").innerHTML = display_year;
		get_year();
	}

	function year_up() {
		display_year++;
		draw_main();
	}

	function year_down() {
		display_year--;
		draw_main();
	}

	function get_year() {
		document.getElementById('year').innerHTML = '';

		const data = null;

		//GET data from api
		const request = new XMLHttpRequest();
		request.open('GET', 'yearcourses_' + display_year + '.json', true);

		request.onload = function () {
			if (this.status >= 200 && this.status < 400) {				// Success!
				var data = JSON.parse(this.response);
				draw_everything(data);
			}
			else {
				alert("Failed to get data from the server. Probably a network hiccough, try again.");
				//TODO: I'd rather the course schedule itself just had a stamp message like 'NO DATA' instead of forcing the user to acknowledge the network fail and click to proceed
			}
		};
		request.onerror = function () {
			alert("There was a connection error. Check you're online, then try again.");
		};
		request.send();
	}

	function draw_everything(data) {
		//get how many and which streams are visible, jumping out if none are
		//The original app had 5+ streams for off premises courses. I nixed those for simplicity here
		//There were originally 3 lecture rooms, plus workshop rooms, seminars off premises, and random hotel/govt conferences 

		const stream_1 = document.getElementById('stream1').checked;
		const stream_2 = document.getElementById('stream2').checked;
		const stream_3 = document.getElementById('stream3').checked;
		const number_of_streams = stream_1 + stream_2 + stream_3;

		if (number_of_streams < 1) {
			return;
		} //Draw nothing 

		const calendar_gap = 6;	//An arbitrary height for the row to display the calendar dates
		const number_of_quarters = 4;
		const calendar_height = 96;
		const stream_height = (calendar_height - (4 * calendar_gap)) / number_of_quarters / number_of_streams;

		draw_calendar(number_of_streams, calendar_height, calendar_gap, number_of_quarters, stream_height);		//Draw the calendar dates etc for the year
		draw_slots(data, stream_1, stream_2, stream_3, number_of_streams, stream_height, calendar_gap);			//Draw the course details for the year

	}


	function draw_slots(data, stream_1, stream_2, stream_3, number_of_streams, stream_height, calendar_gap) {

		//This was designed to be printed out, so having the year at the bottom is handy
		//There were never courses assigned over the holidays so no danger of obscuring info

		//add the year text at the bottom right
		const year_text = document.createElement("div");
		year_text.innerHTML = display_year;
		year_text.className = 'year_text_class';
		document.getElementById('year').appendChild(year_text);

		//Add print/creation date to the bottom too
		const temp = new Date();
		const created_text = document.createElement("div");
		created_text.innerHTML = temp.toDateString() + ' ' + temp.toLocaleTimeString();
		created_text.className = 'created_text_class';
		document.getElementById('year').appendChild(created_text);

		//Pop out if nothing to draw, no point wasting cycles
		if (number_of_streams < 1) { return; }


		const all = document.createElement("div");;
		const current_slot = '';
		const day_width = 1;
		const screen_width = 91;
		const menu_x_offset = 8;
		const number_of_quarters = 4;

		const one_day = 1000 * 60 * 60 * 24;	//javascript measures dates in milliseconds
		const jan1 = new Date('1 January ' + display_year);
		const j1 = jan1.getDay();
		const dd = jan1 - (6 * one_day) - (j1 * one_day);
		const year_first_day = new Date(dd);
		const date_counter = year_first_day;
		const mod_date = false;

		// I saw this comment from some older code which sheds some light onto the reasoning for this
		// Adjust the 'first' day of the year to conform to our wishes; it can be as far back as Dec 28th or
		// as late as Jan 3. Outside those bounds we shift the date 1 week accordingly
		if (year_first_day.getDate() > 16 && year_first_day.getDate() < 27) {
			date_counter.setDate(date_counter.getDate() + 7);
		}
		if (year_first_day.getDate() < 15 && year_first_day.getDate() > 2) {
			date_counter.setDate(date_counter.getDate() - 7);
		}


		for (let slot in data) {

			//We need to track the visibility of the streams from the UI toggles, they'll affect the slot heights and other spacing
			//It's a simple accumulator idea
			let draw_level = 0;
			let draw_me = false;

			if (data[slot].stream == 1 && stream_1) {
				draw_me = true;
				draw_level = 0;
			}

			if (data[slot].stream == 2 && stream_2) {
				draw_me = true;
				if (stream_1) { draw_level += 1; }
				else { draw_level = 0; }
			}

			if (data[slot].stream == 3 && stream_3) {
				draw_me = true;
				if (stream_1) { draw_level += 1; }
				if (stream_2) { draw_level += 1; }
				if (!stream_1 && !stream_2) { draw_level = 0; }
			}


			if (draw_me) {
				const date_start = new Date(data[slot].date_start);
				const date_end = new Date(data[slot].date_end);
				const course_days = new Date(date_end - date_start);
				let slot_width = Math.round(course_days / one_day) + 1;

				const slot_x_offset = new Date(date_start - date_counter);
				let slot_x = Math.round(slot_x_offset / one_day);
				let slot_y = calendar_gap + (draw_level * stream_height);

				const special_comment = document.createElement("div");
				const tally_text = document.createElement("div");
				const shared_tally_text = document.createElement("div");

				//Add a hover-tooltip with some extra info
				const tooltip_text = data[slot].code + '\x0A' + data[slot].po + '\x0APassword: ' + data[slot].s_password + '\x0AQuiz: ' + data[slot].setup_quiz;	// \x0A = newline character

				//Calculate overshoot of right edge of calendar
				if (slot_x >= (3 * screen_width)) {
					slot_x -= screen_width;
					slot_y += (stream_height * number_of_streams) + calendar_gap;
				}
				if (slot_x >= (2 * screen_width)) {
					slot_x -= screen_width;
					slot_y += (stream_height * number_of_streams) + calendar_gap;
				}
				if (slot_x >= (1 * screen_width)) {
					slot_x -= screen_width;
					slot_y += (stream_height * number_of_streams) + calendar_gap;
				}

				//overlap check. Some courses spanned several weeks and visually would overshoot the end of a quarter
				let overlap = 0;
				if (slot_x + slot_width >= screen_width) {
					overlap = (slot_x + slot_width) - screen_width;
					slot_width = screen_width - slot_x;
				}

				//font_size multiplier should be 'lines of text / stream height in vh

				//course_info text components
				const lines_of_text = 4;//default for normal sizes/styles of course_slot_inner

				const po_text = data[slot].po;
				const code_text = data[slot].code;
				const rotate = '';	//Some 1 day courses needed their info rotated ertically to fit in
				let class_list = 'course_slot';
				const box_height = stream_height;

				const info_text = '</li><li class="schedule_li">' + code_text + '</li><li class="po schedule_li">' + po_text + '</li>';

				//Short courses= less space to display info
				if (slot_width == 1) { info_text = '<li class="schedule_li po" style="margin-top:' + (stream_height / 2 - 1) + 'vh;">' + po_text + '</li>'; rotate = ' rotate_text'; class_list += ' rotate_slot_detected'; lines_of_text = 1; box_height = slot_width; }

				if (slot_width > 1 && slot_width < 5) { lines_of_text = 4; class_list += ' rotate_slot_detected'; }

				let font_size_multiplier = slot_width / lines_of_text;//?? probably better to go uniform

				if (font_size_multiplier > 1.5) { font_size_multiplier = 1.5; }	//Math.ceiling?? whatever...
				if (font_size_multiplier < 1) { font_size_multiplier = 1; }

				//NOTE: the original course schedule had a plethora of visual info, with icons and colours signifying data. I used a class list to control most of these.
				//These below do nothing, but I've kept them here in case I feel like bringin back the detail intense version someday
				//set up a string class_list to hold all the applicable css style classes for this course_slot
				if (data[slot].accommodation == 'Residence') { class_list += ' dormant_highlight_residence'; }
				if (data[slot].cost_shared == true) { class_list += ' dormant_highlight_shared_costs'; }
				if (data[slot].extra_language_id == 2) { class_list += ' dormant_highlight_interpretation'; }

				const background_colour = data[slot].background_main;

				background_style = 'background:' + background_colour + ';';

				const course_inner_text = document.createElement("div");
				course_inner_text.style.cssText = "overflow:hidden;height:calc(" + stream_height + "vh - 1px);";
				const course_inner_list = document.createElement("ul");
				course_inner_list.style.cssText = "list-style-type:none;"
				course_inner_list.className = 'schedule_ul ' + rotate;	//rotate's text 90deg if necc.
				course_inner_list.innerHTML = info_text;
				course_inner_text.appendChild(course_inner_list);

				let overlap_offset = 0;
				//draw the overlapped part, one quarter lower
				if (overlap > 0) {
					overlap_offset = 1;
					const new_slot_y = slot_y + (stream_height * number_of_streams) + calendar_gap;
					const overlap_slot = document.createElement("div");
					overlap_slot.title = tooltip_text;
					overlap_slot.className = class_list + ' overlap_leading_edge';			//This leading edge class makes little 'tear strips' appear
					overlap_slot.style.cssText = 'font-size:' + (font_size_multiplier * 0.8) + 'vh;' +
						'line-height:' + font_size_multiplier + 'vh;' +
						'width:calc(' + (overlap * day_width) + 'vw);' +
						'height:calc(' + stream_height + 'vh - 1px);' +
						'left:calc(' + 0 + 'vw);' +
						'top:calc(' + new_slot_y + 'vh + 1px);' +
						background_style +
						'color:' + data[slot].foreground + ';';
					overlap_slot.setAttribute('course_id', data[slot].id);
					overlap_slot.setAttribute('course_code', data[slot].code);

					const temp_el_1 = course_inner_text.cloneNode(true);
					overlap_slot.appendChild(temp_el_1);
					const temp_el_2 = tally_text.cloneNode(true);
					overlap_slot.appendChild(temp_el_2);

					all.appendChild(overlap_slot);
					class_list += ' overlap_trailing_edge';		//Like the leading edge, this makes little 'tear strips' appear like you'd see on a stamp
				}

				const current_slot = document.createElement("div");
				current_slot.appendChild(course_inner_text);
				current_slot.title = tooltip_text;
				current_slot.className = class_list;
				current_slot.style.cssText = 'font-size:' + (font_size_multiplier * 0.8) + 'vh;' +
					'line-height:' + font_size_multiplier + 'vh;' +
					'width:calc(' + ((slot_width - overlap_offset) * day_width) + 'vw);' +
					'height:calc(' + stream_height + 'vh - 1px);' +
					'left:calc(' + slot_x + 'vw);' +
					'top:calc(' + slot_y + 'vh + 1px);' +
					background_style +
					'color:' + data[slot].foreground + ';';
				current_slot.setAttribute('course_id', data[slot].id);
				current_slot.setAttribute('course_code', data[slot].code);

				all.appendChild(current_slot);
			}
		}

		document.getElementById('year').appendChild(all);
	}


	function draw_slots_temp(data, stream_1, stream_2, stream_3, number_of_streams, stream_height, calendar_gap) {

		//This is defunct, just keeping it for posterity to see how silly ideas can be fixed with effort

		//Slots are courses for DIV purposes

		//BUG: courses are drawn 3 days too late and 1 vh too low (origina at top-left)
		//BUG: courses are drawn on same stream level regardless of actual stream > turns out theres code i forgot to copy over that takes care of that draw_level
		//		I  omitted it thinking it was tooltip stuff

		let all = '';
		let current_slot = '';
		const day_width = 1;
		const one_day = 1000 * 60 * 60 * 24;	//javascript milliseconds of a day
		const screen_width = 91;				//91 days per quarter, we don't care about the missing 1.25 days over the holidays

		for (let slot in data) {
			//check is this slot in a visible stream
			if (
				(data[slot].stream == 1 && stream_1) ||
				(data[slot].stream == 2 && stream_2) ||
				(data[slot].stream == 3 && stream_3)
			) {

				if (data[slot].id != null) {

					//BUG: draw_level is fine until stream 2 is toggled hidden. need logic to tally draw_level 
					//There isn't a truth table logic for this, unfo. It needs a tally logic. Fix it later. It's ok for testing now

					draw_level = data[slot].stream - number_of_streams + 2;

					const date_start = new Date(data[slot].date_start);
					const date_end = new Date(data[slot].date_end);	//need to take date_end+1
					const course_duration = new Date(date_end - date_start);
					const slot_width = Math.floor(course_duration / one_day) + 1;
					const level = data[slot].stream - 1;	//not so simple, stream = lecture_room_id which is not linear; we need to assign these accurately
					if (level > 6) { level = 4; }	//account for odd indexing from sql of lecture_room_id table					

					const jan1 = new Date('1 January ' + display_year);
					const course_start_offset = new Date(date_start - jan1);
					let slot_x = Math.floor(course_start_offset / one_day);
					let slot_y = calendar_gap + (draw_level * stream_height);

					//Calculate overshoot of right edge of calendar
					if (slot_x + slot_width > (3 * screen_width)) {
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (2 * screen_width)) {
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}
					if (slot_x + slot_width > (1 * screen_width)) {
						slot_x -= screen_width;
						slot_y += (stream_height * number_of_streams) + calendar_gap;
					}


					const rotate = '';
					if (slot_width < 4) { rotate = " rotate_text"; };
					const font_size = 0.15 * slot_width;

					current_slot = '<div class="course_slot' + '" style="' +
						'font-size:' + font_size + 'vh;' +
						'width:calc(' + (slot_width * day_width) + 'vw);' +
						'height:calc(' + stream_height + 'vh);' +
						'left:calc(5vw + ' + slot_x + 'vw);' +
						'top:calc(' + slot_y + 'vh);' +
						'background-color:' + data[slot].background_main + ';' +
						'color:' + data[slot].foreground + ';' +
						'" data-myattribute="' + data[slot].id +
						'"><div class="course_slot_inner' + rotate + '">' + data[slot].code + ' <br> ' + data[slot].po + '</div></div>';

					all += current_slot;
				}
			}
		}

		//TODO: the response delay prevents instant drawing, either find a method to account for delay then draw, or revert back to the older flickery method

		document.getElementById('year').innerHTML += all;

		//This bit below was suppsed to allow admin to 'zoom' in to the course admin module, but I don't need that here.
		// var entire_class = document.getElementsByClassName('course_slot');
		// for (var i = 0; i < entire_class.length; i++) {
		// 	entire_class[i].addEventListener('click', myFunction, false);
		// }
	}

	Date.prototype.getWeek = function () {
		//returns the week number of the year. Not interested in any ISO definitions, like working week, v calendar week, etc.
		const d = new Date(+this);
		d.setHours(0, 0, 0, 0);
		d.setDate(d.getDate() + 4 - (d.getDay() || 7));
		return Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 8.64e7) + 1) / 7);	//8.64e7 is one day in milliseconds
	}

	function draw_calendar(number_of_streams, calendar_height, calendar_gap, number_of_quarters, stream_height) {
		//populate the month/week/date lines with their content
		//need to calculate the '1st' week of the year, week_position_1 can never have wed=5th jan which constrains our choice		

		const y_pos_increment = 24;
		const calendar = document.getElementById('calendar');
		let inner_calendar = '';
		let y_pos = 0;
		const even_month_colour = "#ffeebb";
		const odd_month_colour = "#ddccaa";
		let month_colour = [even_month_colour, odd_month_colour];	//make an array to hold the alternating colours, then mod2 it as needed

		const first_quarter = 1, last_quarter = 4;

		for (let i = first_quarter; i <= last_quarter; i++) {

			inner_calendar += '<div id="months_quarter_' + i + '" class="month_line" style="top:' + y_pos + 'vh;background:' + month_colour[i % 2] + '"></div>';

			inner_calendar += '<div id="weeks_quarter_' + i + '" class="week_line" style="top:' + (2 + y_pos) + 'vh;"></div>';

			inner_calendar += '<div id="dates_quarter_' + i + '" class="date_line" style="top:' + (4 + y_pos) + 'vh;"></div>';

			for (let j = 0; j < number_of_streams; j++) {
				inner_calendar += '<div class="streams" style="top:' + ((calendar_gap + y_pos) + (stream_height * j)) + 'vh;height:' + stream_height + 'vh;"></div>';
			}

			y_pos += y_pos_increment;
		}

		calendar.innerHTML = inner_calendar;

		//TODO: think of a better name for date_holder

		let date_holder = calculate_firstday();

		draw_weeks_labels(date_holder);

		draw_dates_labels(date_holder);

	}

	function calculate_firstday() {
		const one_day = 1000 * 60 * 60 * 24; //Duration of a single day in javascript milliseconds

		//We're trying to get the first Thursday of the year that has it's Monday in January as well. There's a simpler way to do this I'm sure...
		//I can't remember why I needed to do this, but I definitely did, and really don't have the desire to figure out a better way just yet.
		//I leave it as testimony for the necessity of writing readable code
		//WISH: see if there is a simple way to do this
		const jan_1st = new Date('1 January ' + display_year);
		const jan_1st_day = jan_1st.getDay();
		const days_difference = jan_1st - (6 * one_day) - (jan_1st_day * one_day);
		const year_first_day = new Date(days_difference);
		let date_counter = year_first_day;

		if (year_first_day.getDate() > 16 && year_first_day.getDate() < 27) {
			date_counter.setDate(date_counter.getDate() + 7);
		}
		if (year_first_day.getDate() < 15 && year_first_day.getDate() > 2) {
			date_counter.setDate(date_counter.getDate() - 7);
		}

		return date_counter;
	}

	function draw_weeks_labels(date_holder) {

		//Set these to the first day of the year individually, otherwise they overwrite each other and it looks embarassing
		const week_counter_q1 = new Date(date_holder);
		const week_counter_q2 = new Date(date_holder);
		const week_counter_q3 = new Date(date_holder);
		const week_counter_q4 = new Date(date_holder);

		week_counter_q1.setDate(date_holder.getDate() + 3);						//First Thursday of a full week
		week_counter_q2.setDate(date_holder.getDate() + 3 + 91);				//First Thursday, 3 months later
		week_counter_q3.setDate(date_holder.getDate() + 3 + 91 + 91);			//etc...
		week_counter_q4.setDate(date_holder.getDate() + 3 + 91 + 91 + 91);
		const weeks_q1 = document.getElementById("weeks_quarter_1");
		const weeks_q2 = document.getElementById("weeks_quarter_2");
		const weeks_q3 = document.getElementById("weeks_quarter_3");
		const weeks_q4 = document.getElementById("weeks_quarter_4");
		const week_bg_color = ['whitesmoke', 'rgb(224,224,216)'];				//altnerating colours for the weeks, mod2 later

		//Loop through 12 weeks of the quarter, attaching relevant styles and content to each div created per week
		//We can do each quarter in parallel, why not
		for (let i = 0; i <= 12; i++) {
			const dc1 = document.createElement("div");
			dc1.innerHTML = week_counter_q1.getWeek();
			dc1.className = "week_style";
			dc1.style.cssText = "left:" + (i * 7) + "vw;background:" + week_bg_color[i % 2] + ";";
			weeks_q1.appendChild(dc1);
			week_counter_q1.setDate(week_counter_q1.getDate() + 7);

			const dc2 = document.createElement("div");
			dc2.innerHTML = week_counter_q2.getWeek();
			dc2.className = "week_style";
			dc2.style.cssText = "left:" + (i * 7) + "vw;background:" + week_bg_color[i % 2] + ";";
			weeks_q2.appendChild(dc2);
			week_counter_q2.setDate(week_counter_q2.getDate() + 7);

			const dc3 = document.createElement("div");
			dc3.innerHTML = week_counter_q3.getWeek();
			dc3.className = "week_style";
			dc3.style.cssText = "left:" + (i * 7) + "vw;background:" + week_bg_color[i % 2] + ";";
			weeks_q3.appendChild(dc3);
			week_counter_q3.setDate(week_counter_q3.getDate() + 7);

			const dc4 = document.createElement("div");
			dc4.innerHTML = week_counter_q4.getWeek();
			dc4.className = "week_style";
			dc4.style.cssText = "left:" + (i * 7) + "vw;background:" + week_bg_color[i % 2] + ";";
			weeks_q4.appendChild(dc4);
			week_counter_q4.setDate(week_counter_q4.getDate() + 7);
		}

	}

	function get_pretty_month_name(d) {
		const monthNames = [
			"January", "February", "March",
			"April", "May", "June", "July",
			"August", "September", "October",
			"November", "December"
		];
		const date = new Date(d);
		const monthIndex = date.getMonth();
		return monthNames[monthIndex];
	}

	function draw_dates_labels(date_holder) {
		//Makes a heap of divs for month names, dates, etc and colours and texts them accordingly

		const even_month_colour = "#ffeebb";
		const odd_month_colour = "#ddccaa";
		let month_colour = [even_month_colour, odd_month_colour];	//make an array to hold the alternating colours, then mod2 it as needed

		const date_counter_q1 = new Date(date_holder);
		const date_counter_q2 = new Date(date_holder);
		const date_counter_q3 = new Date(date_holder);
		const date_counter_q4 = new Date(date_holder);
		date_counter_q2.setDate(date_holder.getDate() + 91);
		date_counter_q3.setDate(date_holder.getDate() + 91 + 91);
		date_counter_q4.setDate(date_holder.getDate() + 91 + 91 + 91);

		//loop 1-91 to populate the dates in each quarter
		const dates_q1 = document.getElementById("dates_quarter_1");
		const dates_q2 = document.getElementById("dates_quarter_2");
		const dates_q3 = document.getElementById("dates_quarter_3");
		const dates_q4 = document.getElementById("dates_quarter_4");
		//we'll add months in here too; when we reach day 15 we add a month name to the month div
		//and a month dividing line when we read day 1
		const months_q1 = document.getElementById("months_quarter_1");
		const months_q2 = document.getElementById("months_quarter_2");
		const months_q3 = document.getElementById("months_quarter_3");
		const months_q4 = document.getElementById("months_quarter_4");

		for (let i = 0; i < 91; i++) {		//91 for days in quarter (3 months)

			const weekend_style = "";
			if (date_counter_q1.getDay() == 0 || date_counter_q1.getDay() == 6) {
				const wknd = document.createElement("div");
				wknd.style.cssText = "left:" + i + "vw;";
				wknd.className = "date_style weekend_class";
				dates_q1.appendChild(wknd);
			}

			const dc1 = document.createElement("div");
			dc1.innerHTML = date_counter_q1.getDate();
			dc1.className = "date_style" + weekend_style;
			dc1.style.cssText = "left:" + i + "vw;";
			dc1.title = "Tooltip Test";
			dates_q1.appendChild(dc1);

			const dc2 = document.createElement("div");
			dc2.innerHTML = date_counter_q2.getDate();
			dc2.className = "date_style" + weekend_style;
			dc2.style.cssText = "left:" + i + "vw;";
			dc2.title = '';
			dates_q2.appendChild(dc2);

			const dc3 = document.createElement("div");
			dc3.innerHTML = date_counter_q3.getDate();
			dc3.className = "date_style" + weekend_style;
			dc3.style.cssText = "left:" + i + "vw;";
			dc3.title = '';
			dates_q3.appendChild(dc3);

			const dc4 = document.createElement("div");
			dc4.innerHTML = date_counter_q4.getDate();
			dc4.className = "date_style" + weekend_style;
			dc4.style.cssText = "left:" + i + "vw;";
			dc4.title = '';
			dates_q4.appendChild(dc4);


			//TODO & BUG: the stuff below is garish. Find a more elegant solution
			//It also doesn'T work right, some month bg colours bleed over, etc.

			//check if date = 1 or 15 and draw the divider or month name respectively if somehow
			if (date_counter_q1.getDate() == 15) {	//add month name
				const month_name = document.createElement("div");
				month_name.innerHTML = get_pretty_month_name(date_counter_q1);
				month_name.className = "month_style";
				month_name.style.cssText = "left:" + i + "vw;";
				months_q1.appendChild(month_name);
			} if (date_counter_q1.getDate() == 1) {	//add left border and colour the element
				const month_name = document.createElement("div");
				month_colour = even_month_colour;
				const colour_toggle = date_counter_q1.getMonth() % 2;
				if (colour_toggle == 1) { month_colour = odd_month_colour; }
				month_name.className = "month_border";	//add a left border
				month_name.style.cssText = "left:" + (i) + "vw;width:inherit;background:" + month_colour;
				months_q1.appendChild(month_name);
			}

			if (date_counter_q2.getDate() == 15) {
				const month_name = document.createElement("div");
				month_name.innerHTML = get_pretty_month_name(date_counter_q2);
				month_name.className = "month_style";
				month_name.style.cssText = "left:" + i + "vw;";
				months_q2.appendChild(month_name);
			}
			if (date_counter_q2.getDate() == 1) {
				const month_name = document.createElement("div");
				month_colour = even_month_colour;
				const colour_toggle = date_counter_q2.getMonth() % 2;
				if (colour_toggle == 1) { month_colour = odd_month_colour; }
				month_name.className = "month_border";	//add a left border
				month_name.style.cssText = "left:" + (i) + "vw;width:inherit;background:" + month_colour;
				months_q2.appendChild(month_name);
			}

			if (date_counter_q3.getDate() == 15) {
				const month_name = document.createElement("div");
				month_name.innerHTML = get_pretty_month_name(date_counter_q3);
				month_name.className = "month_style";
				month_name.style.cssText = "left:" + i + "vw;";
				months_q3.appendChild(month_name);
			}
			if (date_counter_q3.getDate() == 1) {
				const month_name = document.createElement("div");
				month_colour = even_month_colour;
				const colour_toggle = date_counter_q3.getMonth() % 2;
				if (colour_toggle == 1) { month_colour = odd_month_colour; }
				month_name.className = "month_border";	//add a left border
				month_name.style.cssText = "left:" + (i) + "vw;width:inherit;background:" + month_colour;
				months_q3.appendChild(month_name);
			}

			if (date_counter_q4.getDate() == 15) {
				const month_name = document.createElement("div");
				month_name.innerHTML = get_pretty_month_name(date_counter_q4);
				month_name.className = "month_style";
				month_name.style.cssText = "left:" + i + "vw;";
				months_q4.appendChild(month_name);
			}
			if (date_counter_q4.getDate() == 1) {
				const month_name = document.createElement("div");
				month_colour = even_month_colour;
				const colour_toggle = date_counter_q4.getMonth() % 2;
				if (colour_toggle == 1) { month_colour = odd_month_colour; }
				month_name.className = "month_border";	//add a left border
				month_name.style.cssText = "left:" + (i) + "vw;width:inherit;background:" + month_colour;
				months_q4.appendChild(month_name);
			}

			date_counter_q1.setDate(date_counter_q1.getDate() + 1);
			date_counter_q2.setDate(date_counter_q2.getDate() + 1);
			date_counter_q3.setDate(date_counter_q3.getDate() + 1);
			date_counter_q4.setDate(date_counter_q4.getDate() + 1);

		}


	}


</script>